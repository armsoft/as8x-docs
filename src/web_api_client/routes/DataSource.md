---
layout: page
title: "DataSource" 
tags : DS
---

## Բովանդակություն

- [Ներածություն](#ներածություն)
- [Հատկություններ](#հատկություններ)
  - [Client](#client)
  - [Definition](#definition)
  - [ExtenderSchema](#extenderschema)
  - [FetchSize](#fetchsize)
  - [FirstFetchSize](#firstfetchsize)
  - [ShowProgress](#showprogress)
  - [EncodeResultUnicode](#encoderesultunicode)
- [Մեթոդներ](#մեթոդներ)
  - [ExecuteAsync](#executeasync)
  - [LoadDefinitionAsync](#loaddefinitionasync)
  - [LongExecuteAsync](#longexecuteasync)
- [Օրինակ 1](#օրինակ-1)
- [Օրինակ 2](#օրինակ-2)
- [Օրինակ 3](#օրինակ-3)

## Ներածություն

DataSource դասը նախատեսված է Client ծրագրից Web API-ների միջոցով տվյալների աղբյուրը կատարելու և կատարման արդյունքը վերադարձնելու ֆունկցիոնալությունը ապահովելու համար։

## Հատկություններ

### Client

```c#
public ApiClient Client { get; set; }
```

Վերադարձնում կամ նշանակում է `ApiClient` դասի օբյեկտ, որը նախատեսված է տվյալների աղբյուրի կատարման ընթացքում կլիենտից դեպի սերվեր անհրաժեշտ հարցումներ կատարելու համար։

### Definition

```c#
public DataSourceDefinition Definition { get; set; }
```

Վերադարձնում կամ նշանակում է տվյալների աղբյուրի նկարագրությունը, որը պարունակում է տվյալների աղբյուրի, սյուների և պարամետրերի հատկությունները։

Տվյալների աղբյուրի նկարագրությունը կարելի է ստանալ `DefinitionsCache` դասի `GetDataSourceDefinition` մեթոդի միջոցով։

### ExtenderSchema

```c#
public ExtenderSchemaEx ExtenderSchema { get; set; }
```

Վերադարձնում կամ նշանակում է [տվյալների աղբյուրի ընդլայնման](../../extensions/definitions/ds_extender.md) նկարագրությունը, որը պարունակում է ընդլայնման ներքին անունը, պարամետրերի ու սյուների հատկությունները։

Այս հատկությանը արժեք փոխանցելու դեպքում տվյալների աղբյուրը կատարելիս նաև հաշվարկվում է ընդլայնումը։

Տվյալների աղբյուրի ընդլայնման նկարագրությունը կարելի է ստանալ ApiClient դասի Extender հատկության GetSchema մեթոդի միջոցով՝ փոխանցելով ընդլայնման ներքին անունը։

```c#
ds.ExtenderSchema = apiClient.Extender.GetSchema("CreatDocExtended");
```

Օգտագործման օրինակին ծանոթանալու համար [տե՛ս](#օրինակ-2)։

### FetchSize

```c#
public int FetchSize { get; set; }
```

Տվյալների աղբյուրի կատարման արդյունքում վերադարձվող տողերը սերվիսից կլիենտ բեռնվում են բլոկ առ բլոկ։

Այս հատկությունը վերադարձնում կամ նշանակում է բեռնման յուրաքանչյուր բլոկի տողերի քանակը՝ բացառությամբ առաջինի։

### FirstFetchSize

```c#
public int FirstFetchSize { get; set; }
```

Տվյալների աղբյուրի կատարման արդյունքում վերադարձվող տողերը սերվիսից կլիենտ բեռնվում են բլոկ առ բլոկ։

Այս հատկությունը վերադարձնում կամ նշանակում է բեռնման առաջին բլոկի տողերի քանակը։

### ShowProgress

```c#
public bool ShowProgress { get; set; }
```

Վերադարձնում կամ նշանակում է տվյալների աղբյուրը կատարման և բեռնման գործընթացի պրոգրեսի պատուհանով ցուցադրման հայտանիշը։

### EncodeResultUnicode

```c#
public bool EncodeResultUnicode { get; set; }
```

Վերադարձնում կամ նշանակում է, արդյոք տվյալների աբյուրի տողերի կոդավորումը `Unicode` է, թե ոչ։ 

## Մեթոդներ

### ExecuteAsync

```c#
public Task<DataSourceResult<R>> ExecuteAsync(P param, HashSet<string> columns = default, string isn = null,
                                              CancellationToken cancellationToken = default, TimeSpan? timeout = null)
```

Կատարում է տվյալների աղբյուրը, վերադարձնում ստացված տողերի ցուցակը և կատարման ընթացքում առաջացած սխալների մանրամասն տեղեկությունը։

Այս մեթոդը անհրաժեշտ է օգտագործել այնպիսի տվյալների աղբյուրների կատարման համար, որոնց կատարման ժամանակը չի գերազանցում 180 վայրկյանը։

**Պարամետրեր**

* `param` - Տվյալների աղբյուրի պարամետրերը նկարագրող դասի օբյեկտ՝ `ParameterCollection` դասի ժառանգ։
* `columns` - Տվյալների աղբյուրի վերադարձվող սյուների անունների ցուցակ։ Արժեք չփոխանցելու դեպքում կատարման արդյունքում վերադարձվելու են բոլոր սյուները։
* `isn` - Sql-based տվյալների աղբյուրում տող ավելացնելու, ջնջելու կամ թարմացնելու դեպքում տվյալների աղբյուրի կատարվելիս փոփոխված տողի isn-ը։
* `cancellationToken` - Ընդհատման օբյեկտ:
* `timeout` - Տվյալների աղբյուրի կատարման հարցման առավելագույն ժամանակը։ Արժեք չփոխանցելու դեպքում հարցման կատարման առավելագույն ժամանակ համարվելու է 180 վրկ (3 ր)։

### LoadDefinitionAsync

```c#
public async Task LoadDefinitionAsync(string name, CancellationToken cancellationToken = default)
```

Բեռնում է տվյալների աղբյուրի նկարագրությունը և վերագրում [Definition](#definition) հատկությանը։

**Պարամետրեր**

* `param` - Տվյալների աղբյուրի ներքին անունը։
* `cancellationToken` - Ընդհատման օբյեկտ:

### LongExecuteAsync

```c#
public Task<DataSourceResult<R>> LongExecuteAsync(P param, HashSet<string> columns = default, 
                                                  string isn = null, bool handleEvents = false,
                                                  CancellationToken cancellationToken = default, TimeSpan? timeout = null)
```

Կատարում է տվյալների աղբյուրը, վերադարձնում ստացված տողերի ցուցակը և կատարման ընթացքում առաջացած սխալների մանրամասն տեղեկությունը։

Այս մեթոդը անհրաժեշտ է օգտագործել այնպիսի տվյալների աղբյուրների կատարման համար, որոնց կատարման ժամանակը գերազանցում է 180 վայրկյանը կամ անհայտ է։

Մեթոդը հերթի է դնում տվյալների աղբյուրի կատարումը, հարցնում է կատարման ընթացքի մասին ինֆորմացիա, քանի դեռ կատարումը չի ավարտվել և վերջում վերադարձնում է կատարման արդյունքը։

Տե՛ս նաև [Ասինխրոն մշակում կիրառությունների սերվերի վրա](../../architecture/appserver_async.md):

**Պարամետրեր**

* `R` - Տվյալների աղբյուրի տողը նկարագրող դասի օբյեկտ՝ `ExtendableRow` դասի ժառանգ։
* `param` - Տվյալների աղբյուրի պարամետրերը նկարագրող դասի օբյեկտ՝ `ParameterCollection` դասի ժառանգ։
* `columns` - Տվյալների աղբյուրի վերադարձվող սյուների անունների ցուցակ։ Արժեք չփոխանցելու դեպքում կատարման արդյունքում վերադարձվելու են բոլոր սյուները։
* `isn` - Sql-based տվյալների աղբյուրում տող ավելացնելու, ջնջելու կամ թարմացնելու դեպքում տվյալների աղբյուրի կատարվելիս փոփոխված տողի isn-ը։
* `cancellationToken` - Ընդհատման օբյեկտ:
* `timeout` - Տվյալների աղբյուրի կատարման արդյունքի ստացման հարցման առավելագույն ժամանակը։ Արժեք չփոխանցելու դեպքում հարցման կատարման առավելագույն ժամանակ համարվելու է 180 վրկ (3 ր)։


## Օրինակ 1

Ներկայացված է օգտագործողի նույնականացման ու տվյալների աղբյուրի կանչի օրինակ կլիենտից։
Այս օրինակում տվյալների աղբյուրը կատարվում է [ExecuteAsync](#executeasync) մեթոդի միջոցով, քանի որ կատարման ժամանակը փոքր է։
Տվյալների աղբյուրի պարամետրերը և կատարման արդյունքի սյուները ներկայացված են ոչ տիպիզացված եղանակով՝ համապատասխանաբար `ParameterCollection` և `ExtendableRow` դասերի միջոցով։
Այս դեպքում պարամետրերի արժեքները փոխանցվում են indexer-ի միջոցով, ինչի պատճառով կոմպիլյացիայի ժամանակ տիպի ստուգում տեղի չի ունենում։

Օրինակում ներկայացված տվյալների աղբյուրի սերվիսային նկարագրությանը ծանոթանալու համար [տե՛ս](../../server_api/examples/ds/sql_based_code.cs):

Տվյալների աղբյուրի կանչի համար անհրաժեշտ է որ լինի նախապես նույնականացված օգտագործող։ Օրինակի համար [տե՛ս](LoginService.md):

```c#
// Ստեղծում է DataSource դասի օբյեկտ, Client հատկությանը փոխանցելով ApiClient դասի օբյեկտ:
// Client հատկության արժեքավորումը պարտադիր է, քանի որ այն նախատեսված է տվյալների աղբյուրի կատարման համար 
// անհրաժեշտ http հարցումներ կլիենտից սերվիս ուղարկելու համար։
var ds = new DataSource()
{
    Client = new ApiClient(this.loginService, this.httpClient, null)
};

// Բեռնում է տվյալների աղբյուրի նկարագրությունը՝ ըստ ներքին անվան։
await ds.LoadDefinitionAsync("TreeNode");

// Պարամետրերի նկարագրման համար անհրաժեշտ է ստեղծել ParameterCollection դասի օբյեկտ՝
// Definition հատկությանը պարտադիր փոխանցելով տվյալների աղբյուրի Definition-ի Parameters հատկությունը։
var parameters = new ParameterCollection() { Definition = ds.Definition.Parameters };

// parameters օբյեկտի indexer-ի միջոցով անհրաժեշտ է նշել պարամետրերի արժեքները՝ 
// նշելով պարամետրի անունը և փոխանցելով անհրաժեշտ արժեքը։
// Փոխանցվող արժեքը object տիպի է։
parameters["TreeId"] = "Banks";
parameters["NodeType"] = "1";

// Տվյալների աղբյուրը կատարելու համար անհրաժեշտ է կանչել ExecuteAsync մեթոդը՝ պարտադիր փոխանցելով պարամետրերը։
// Քանի որ վերադարձվող սյուների անունները որպես պարամետր փոխանցված չեն, ապա կատարման արդյունքում կվերադարձվեն բոլոր սյուները։
var dsResult = await ds.ExecuteAsync(parameters);

// Տվյալների աղբյուրի տողերը ստանալու համար անհրաժեշտ է դիմել կատարման արդյունքի Rows հատկությանը։
foreach (var row in dsresult.Rows)
{
    // Տողի սյան արժեքը ստանալու համար անհրաժեշտ է դիմել տողի օբյեկտի indexer-ին՝ փոխանցելով անհրաժեշտ սյան անունը
    Debug.WriteLine(row["Code"]);
    Debug.WriteLine(row["Name"]);
}
```

## Օրինակ 2

Ներկայացված է օգտագործողի նույնականացման ու տվյալների աղբյուրի և իր ընդլայնման կանչի օրինակ կլիենտից։

Այս օրինակում տվյալների աղբյուրը կատարվում է [LongExecuteAsync](#longexecuteasync) մեթոդի միջոցով, քանի որ կատարման ժամանակը մեծ է։
Տվյալների աղբյուրի պարամետրերը և կատարման արդյունքի սյուները ներկայացված են ոչ տիպիզացված եղանակով՝ համապատասխանաբար `ParameterCollection` և `ExtendableRow` դասերի միջոցով։
Այս դեպքում պարամետրերի արժեքները փոխանցվում են և սյան արժեքները ստացվում են indexer-ի միջոցով, ինչի պատճառով կոմպիլյացիայի ժամանակ տիպի ստուգում տեղի չի ունենում։

Տվյալների աղբյուրի կանչի համար անհրաժեշտ է, որ լինի նախապես նույնականացված օգտագործող։ Օրինակի համար [տե՛ս](LoginService.md):

```c#
var apiClient = new ApiClient(this.loginService, this.httpClient, null);

// Ստեղծում է DataSource դասի օբյեկտ, Client հատկությանը փոխանցելով ApiClient դասի օբյեկտ:
// Client հատկության արժեքավորումը պարտադիր է, քանի որ այն նախատեսված է տվյալների աղբյուրի կատարման համար 
// անհրաժեշտ http հարցումներ կլիենտից սերվիս ուղարկելու համար։
var ds = new DataSource()
{
    Client = apiClient
};

//Բեռնում է տվյալների աղբյուրի նկարագրությունը՝ ըստ ներքին անվան։
await ds.LoadDefinitionAsync("CREATDOC");

// Պարամետրերի նկարագրման համար անհրաժեշտ է ստեղծել ParameterCollection դասի օբյեկտ՝
// Definition հատկությանը պարտադիր փոխանցելով տվյալների աղբյուրի Definition-ի Parameters հատկությունը։
var parameters = new ParameterCollection() { Definition = ds.Definition.Parameters };

// parameters օբյեկտի indexer-ի միջոցով անհրաժեշտ է նշել պարամետրերի արժեքները՝ 
// նշելով պարամետրի անունը և փոխանցելով անհրաժեշտ արժեքը։
// Փոխանցվող արժեքը object տիպի է։
parameters["StartDate"] = new DateTime(2024, 01, 01);
parameters["EndDate"] = new DateTime(2024, 11, 14);

// Ստանում է տվյալների աղբյուրի նկարագրությունը GetSchema մեթոդի միջոցով՝ փոխանցելով ընդլայնման ներքին անունը։
var extenderDefinition = apiClient.Extender.GetSchema("CreatDocExtended");

// Տվյալների աղբյուրի օբյեկտի ExtenderSchema հատկությանը փոխանցում է այն ընդլայնման նկարագրությունը,
// որով  կատարվելու է տվյալների աղբյուրը։
ds.ExtenderSchema = extenderDefinition;

// Տվյալների աղբյուրի կատարման համար անհրաժեշտ է կանչել LongExecute մեթոդը՝ պարտադիր փոխանցելով կատարման համար անհրաժեշտ պարամետրերը
// և վերադարձվող սյուների անունները: Ընդլայնման սյուները վերադարձնելու համար անհրաժեշտ է փոխանցել սյան անունները "Entender_" նախածանցով:
// Վերադարձվող սյուների անունները չնշելու դեպքում վերադարձվելու են տվյալների աղբյուրի և ընդլայնման բոլոր սյուները։
var columns = new HashSet<string> { "fNAME", "Extender_Amsativ" }; 
var dsResult = await ds.LongExecuteAsync(parameters, columns);

// Տվյալների աղբյուրի տողերը ստանալու համար անհրաժեշտ է դիմել կատարման արդյունքի Rows հատկությանը։
foreach (var row in dsresult.Rows)
{
    // Տողի սյան արժեքը ստանալու համար անհրաժեշտ է դիմել տողի օբյեկտի indexer-ին՝ փոխանցելով անհրաժեշտ սյան անունը։
    Debug.WriteLine(row["fNAME"]);

    // ընդլայնման սյան արժեքը ստանալու անհրաժեշտ է դիմել տողի օբյեկտի indexer-ին՝ փոխանցելով ընդլայնման սյան անունը "Entender_" նախածանցով։
    Debug.WriteLine(row["Extender_Amsativ"]);
}
```

## Օրինակ 3

Ներկայացված է օգտագործողի նույնականացման ու տվյալների աղբյուրի կանչի օրինակ կլիենտից։

Այս օրինակում տվյալների աղբյուրը կատարվում է [ExecuteAsync](#executeasync) մեթոդի միջոցով, քանի որ կատարման ժամանակը փոքր է։

Տվյալների աղբյուրի պարամետրերը և կատարման արդյունքի սյուները ներկայացված են տիպիզացված եղանակով՝ այսինքն սահմանված են դասեր տվյալների աղբյուրի պարամետրերի և տողի նկարագրման համար, որոնք ժառանգում են համապատասխանաբար `ParameterCollection` և `ExtendableRow` դասերից։

Այս դեպքում պարամետրերի արժեքները փոխանցվում են դասի հատկությունների միջոցով, հետևաբար կոմպիլյացիայի ժամանակ տիպի ստուգում է տեղի ունենում։

Օրինակում ներկայացված տվյալների աղբյուրի սերվիսային նկարագրությանը ծանոթանալու համար [տե՛ս](../../server_api/examples/ds/sql_based_code.cs):

Տվյալների աղբյուրի կանչի համար անհրաժեշտ է, որ լինի նախապես նույնականացված օգտագործող։ Օրինակի համար [տե՛ս](LoginService.md):

```c#
public class DataRow : ExtendableRow
{
    public string Code { get; set; }
    public string Name { get; set; }
}

public class Param : ParameterCollection
{
    public string TreeId
    {
        get { return (string)base[nameof(this.TreeId)]; }
        set { base[nameof(this.TreeId)] = value; }
    }
    public string NodeType
    {
        get { return (string)base[nameof(this.NodeType)]; }
        set { base[nameof(this.NodeType)] = value; }
    }
}
```

```c#
var apiClient = new ApiClient(this.loginService, this.httpClient, null);

// Ստեղծում է DataSource դասի օբյեկտ, որը ստանում է պարամետրերը և սյուները նկարագրող տիպիզացված դասերը։
// DS-ի Client հատկությանը փոխանցում է ApiClient դասի օբյեկտ:
// Client հատկության արժեքավորումը պարտադիր է, քանի որ այն նախատեսված է տվյալների աղբյուրի կատարման համար 
// անհրաժեշտ http հարցումներ կլիենտից սերվիս ուղարկելու համար։
var ds = new DataSource<DataRow, Param>
{
    Client = apiClient
};

// Բեռնում է տվյալների աղբյուրի նկարագրությունը՝ ըստ ներքին անվան։
await ds.LoadDefinitionAsync("TreeNode");

// Պարամետրերի արժեքավորման համար անհրաժեշտ է պարամետրերը նկարագրող դասի օբյեկտ՝
// Definition հատկությանը պարտադիր փոխանցելով տվյալների աղբյուրի Definition-ի Parameters հատկությունը և պարամետրերին փոխանցելով անհրաժեշտ արժեքները։
var parameters = new Param() 
{ 
  Definition = ds.Definition.Parameters, 
  TreeId = "Banks",
  NodeType = "1"
};

// Տվյալների աղբյուրը կատարելու համար անհրաժեշտ է կանչել ExecuteAsync մեթոդը՝ պարտադիր փոխանցելով պարամետրերը։
// Քանի որ վերադարձվող սյուների անունները որպես պարամետր փոխանցված չեն, ապա կատարման արդյունքում կվերադարձվեն բոլոր սյուները։
var dsResult = await ds.ExecuteAsync(parameters);

// Տվյալների աղբյուրի տողերը ստանալու համար անհրաժեշտ է դիմել կատարման արդյունքի Rows հատկությանը։
foreach (var row in dsresult.Rows)
{
    // Տողի սյան արժեքը ստանալու համար անհրաժեշտ է դիմել տողի օբյեկտի սյան անունով հատկությանը
    Debug.WriteLine(row.Code);
    Debug.WriteLine(row.Name);
}
```

